# نظرة عامة على آلية عمل الردود الآلية

## التدفق العام

```
┌─────────────────────────────────────────────────────────────┐
│                    رسالة واردة من WhatsApp                   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │   تحديد نوع المحادثة        │
        └─────────────┬───────────────┘
                      │
        ┌─────────────┴───────────────┐
        │                             │
        ▼                             ▼
┌───────────────┐            ┌────────────────┐
│ محادثة خاصة   │            │ مجموعة (جروب)  │
│ @s.whatsapp   │            │ @g.us          │
└───────┬───────┘            └────────┬───────┘
        │                             │
        ▼                             ▼
┌───────────────────┐        ┌────────────────────┐
│ نظام الردود الآلية│        │ نظام الجسر         │
│ Private Chat      │        │ Bridge to Telegram │
└───────┬───────────┘        └────────────────────┘
        │
        ▼
┌───────────────────────────┐
│ استخراج نص الرسالة        │
└───────────┬───────────────┘
            │
            ▼
┌───────────────────────────────────┐
│ checkPrivateChatKeyword(text)     │
│ البحث عن كلمة مفتاحية            │
└───────────┬───────────────────────┘
            │
    ┌───────┴────────┐
    │                │
    ▼                ▼
┌────────┐      ┌──────────┐
│ موجودة  │      │ غير موجودة│
└────┬───┘      └──────┬───┘
     │                 │
     │                 ▼
     │          ┌─────────────┐
     │          │ عدم الرد    │
     │          │ (صمت)       │
     │          └─────────────┘
     │
     ▼
┌─────────────────────────────┐
│ تحديد نوع الرد              │
└─────────────┬───────────────┘
              │
    ┌─────────┼─────────┬─────────┐
    ▼         ▼         ▼         ▼
┌──────┐ ┌────────┐ ┌──────┐ ┌────────┐
│ نص   │ │ صورة   │ │ ملف  │ │ كامل   │
│ text │ │ image  │ │ doc  │ │ both   │
└──┬───┘ └───┬────┘ └───┬──┘ └───┬────┘
   │         │           │        │
   │         │           │        │
   └─────────┴───────────┴────────┘
                  │
                  ▼
        ┌───────────────────┐
        │ إرسال الرد للمستخدم│
        │ في نفس المحادثة    │
        └───────────────────┘
```

## أنواع الردود المدعومة

### 1️⃣ رد نصي (text)
```
المستخدم: "مواعيد المحاضرات؟"
         ↓
البوت:   "📅 جدول المحاضرات:
         الأحد: 10 صباحاً - محاسبة
         الاثنين: 2 مساءً - إحصاء"
```

### 2️⃣ رد بصورة (image)
```
المستخدم: "جدول الامتحانات"
         ↓
البوت:   [صورة: schedule.jpg]
         Caption: "📅 جدول الامتحانات"
```

### 3️⃣ رد بملف PDF (document)
```
المستخدم: "ملخص محاسبة"
         ↓
البوت:   [ملف: accounting_summary.pdf]
         Caption: "📚 ملخص مادة المحاسبة"
```

### 4️⃣ رد كامل (both)
```
المستخدم: "اسايمنت المحاضرة الاولي"
         ↓
البوت:   "✍️ Assignment المحاضرة الأولى:
         حل الأسئلة من 1 إلى 5"
         ↓
         [صورة/ملف: assignment1.jpg]
         Caption: "📝 صورة الـ Assignment"
```

## مثال على التكوين

```json
{
  "privateChatResponses": {
    "enabled": true,
    "keywords": [
      {
        "keywords": ["ملخص محاسبة", "ملخص المحاسبة"],
        "responseType": "document",
        "text": null,
        "filePath": "/path/to/accounting_summary.pdf",
        "caption": "📚 ملخص مادة المحاسبة"
      },
      {
        "keywords": ["مواعيد المحاضرات", "جدول المحاضرات"],
        "responseType": "text",
        "text": "📅 جدول المحاضرات:\n\nالأحد: 10 صباحاً...",
        "filePath": null,
        "caption": null
      }
    ]
  }
}
```

## البحث عن الكلمات المفتاحية

### كيف يعمل البحث؟

```javascript
// الرسالة الواردة
const message = "عايز ملخص محاسبة";

// تحويل للأحرف الصغيرة
const messageLower = message.toLowerCase();
// "عايز ملخص محاسبة"

// الكلمات المفتاحية
const keywords = ["ملخص محاسبة", "ملخص المحاسبة"];

// البحث باستخدام includes
keywords.forEach(keyword => {
    if (messageLower.includes(keyword.toLowerCase())) {
        // ✅ تطابق! إرسال الرد
    }
});
```

### أمثلة على التطابق

| الرسالة الواردة | الكلمة المفتاحية | تطابق؟ |
|-----------------|------------------|---------|
| "عايز ملخص محاسبة" | "ملخص محاسبة" | ✅ نعم |
| "ممكن ملخص محاسبة؟" | "ملخص محاسبة" | ✅ نعم |
| "ملخص مادة محاسبة" | "ملخص محاسبة" | ❌ لا (كلمة "مادة" تفصل بينهما) |
| "ملخص المحاسبة" | "ملخص المحاسبة" | ✅ نعم |

## الأوامر المتاحة

### للمشرفين (Elite Users)

```
.تفعيل_ردود                  → تفعيل نظام الردود الآلية
.تعطيل_ردود                  → تعطيل نظام الردود الآلية

.اضافة_رد <نوع> <كلمات> | <محتوى>
                            → إضافة رد جديد

.حذف_رد <كلمة>              → حذف رد موجود

.الردود                      → عرض جميع الردود المضافة

.المساعدة                    → عرض دليل الأوامر
```

## أمثلة على الاستخدام

### مثال 1: إضافة رد نصي
```
.اضافة_رد نص مواعيد المحاضرات,جدول المحاضرات | 📅 جدول المحاضرات:

الأحد: 10 صباحاً - محاسبة
الاثنين: 2 مساءً - إحصاء
الأربعاء: 10 صباحاً - اقتصاد
```

### مثال 2: إضافة رد بملف
```
.اضافة_رد ملف ملخص محاسبة | /home/user/files/accounting_summary.pdf
```

### مثال 3: إضافة رد كامل
```
.اضافة_رد كامل اسايمنت | ✍️ Assignment: حل الأسئلة | /path/to/assignment.jpg
```

### مثال 4: عرض الردود
```
.الردود
```
```
📋 الردود الآلية للمحادثات الخاصة:

1. 🔑 مواعيد المحاضرات, جدول المحاضرات
   📝 النوع: text
   💬 النص: 📅 جدول المحاضرات:...

2. 🔑 ملخص محاسبة
   📝 النوع: document
   📁 الملف: /path/to/summary.pdf
```

## الأمان والخصوصية

### ✅ آمن
- يعمل فقط في المحادثات الخاصة
- لا يتداخل مع المجموعات
- الملفات من السيرفر فقط
- يمكن تعطيله بالكامل

### 🔒 الحماية
- التحقق من نوع المحادثة (private vs group)
- التحقق من وجود الملف قبل الإرسال
- معالجة الأخطاء في حالة عدم وجود الملف
- رسائل خطأ واضحة للمستخدمين

## الاختبارات

تم اختبار الميزة بشكل شامل:

```bash
npm run test:private-chat
```

**النتائج:**
- ✅ 6/6 اختبارات ناجحة
- اختبار التطابق الدقيق
- اختبار عدم التطابق
- اختبار أنواع الردود المختلفة
